<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Mobile WebRTC Camera Publisher</title>
<style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    video { width: 100%; max-width: 360px; background: #000; border-radius: 12px; }
    button, select {
        margin: 10px; padding: 12px 20px; font-size: 16px;
        border-radius: 8px; border: none;
        background: #007AFF; color: white; cursor: pointer;
    }
</style>
</head>
<body>

<h2>ğŸ“· ìŠ¤ë§ˆíŠ¸í° WebRTC ë°©ì†¡</h2>

<video id="preview" autoplay playsinline muted></video>

<br>

<select id="cameraSelect"></select>
<br>

<button id="startBtn">ì¹´ë©”ë¼ ì¼œê¸°</button>
<button id="publishBtn" disabled>ë°©ì†¡ ì‹œì‘</button>

<div id="status">ì¤€ë¹„ë¨</div>

<script>
const server = "192.168.131.216";   // â† ì—¬ê¸°ë¥¼ ë³¸ì¸ SRS ì£¼ì†Œë¡œ ë³€ê²½
const app = "live";
const stream = "mobilecam";
const whipUrl = `http://${server}:1985/rtc/v1/whip/?app=${app}&stream=${stream}`;

let localStream = null;
let pc = null;

// ğŸ“Œ ì¹´ë©”ë¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadCameras() {
try {
        // ì„ì‹œë¡œ ê¶Œí•œì„ ìš”ì²­í•˜ì—¬ ì¥ì¹˜ ëª©ë¡ ì ‘ê·¼ ê¶Œí•œ í™•ë³´
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        // ì‚¬ìš© í›„ ì„ì‹œ ìŠ¤íŠ¸ë¦¼ ì •ì§€
        stream.getTracks().forEach(track => track.stop());

        const cams = devices.filter(d => d.kind === "videoinput");
        const select = document.getElementById("cameraSelect");
        select.innerHTML = "";

        cams.forEach(cam => {
            const op = document.createElement("option");
            op.value = cam.deviceId;
            op.text = cam.label || `ì¹´ë©”ë¼ ${select.length + 1}`;
            select.appendChild(op);
        });
    } catch (err) {
        console.error("ì¥ì¹˜ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", err);
        document.getElementById("status").innerText = "ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš” (HTTPS í™•ì¸)";
    }
}

// ğŸ“Œ ì¹´ë©”ë¼ ì‹œì²­ ì‹œì‘
async function startCamera() {
    const camId = document.getElementById("cameraSelect").value;

    localStream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: camId ? { exact: camId } : undefined },
        audio: true
    });

    document.getElementById("preview").srcObject = localStream;
    document.getElementById("publishBtn").disabled = false;

    document.getElementById("status").innerText = "ì¹´ë©”ë¼ ì—°ê²°ë¨";
}

// ğŸ“Œ WebRTC + WHIP ì†¡ì¶œ
async function publishStream() {
    document.getElementById("status").innerText = "WebRTC ì—°ê²° ì¤‘...";

    pc = new RTCPeerConnection({
        bundlePolicy: "max-bundle"
    });

    // Tracks ë„£ê¸°
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    // Offer ìƒì„±
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // SRS WHIP APIë¡œ SDP ì „ì†¡
    const res = await fetch(whipUrl, {
        method: "POST",
        headers: { "Content-Type": "application/sdp" },
        body: offer.sdp
    });

    const answerSdp = await res.text();

    // answer ì„¤ì •
    await pc.setRemoteDescription({
        type: "answer",
        sdp: answerSdp
    });

    document.getElementById("status").innerText = "ğŸ“¡ ë°©ì†¡ ì¤‘";
}

document.getElementById("startBtn").onclick = startCamera;
document.getElementById("publishBtn").onclick = publishStream;

// ì´ˆê¸° ì¹´ë©”ë¼ ëª©ë¡ ë¡œë“œ
loadCameras();
</script>

</body>
</html>
