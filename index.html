<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRS Multi Video Player</title>
    <style>
        body {
            background-color: #0f0f0f;
        }

        .video-grid {
            display: grid;
            /* grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); */
            grid-template-columns: 1fr;

            gap: 20px;
            padding: 20px;
        }

        .video-container {
            background: #0f0f0f;
            /* border-radius: 8px; */
            overflow: hidden;
            color: white;
        }

        video {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 10px;
        }

        .video-title {
            font-size: 20px;
            color: white;
            padding: 5px;
        }

        h2 {
            color: white;
        }

        /* [2] 브라우저가 최소 300px 영상 2개를 넣을 수 있을 때 (약 620px 이상) */
        @media (min-width: 650px) {
            .video-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* [3] 브라우저가 최소 300px 영상 3개를 넣을 수 있을 때 (약 940px 이상) */
        /* 1600px 미만까지는 여기서 3개로 계속 유지됩니다. */
        @media (min-width: 980px) {
            .video-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* [4] 1600px 이상일 때만 4개로 확장 */
        @media (min-width: 1600px) {
            .video-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>

<body>

    <h2>Live Streaming System</h2>
    <div class="video-grid" id="videoGrid"></div>
    <!-- <button id="startAllBtn" style="margin: 20px; padding: 10px 20px;">모든 스트림 시작</button> -->
    <!-- <button id="stopAllBtn" style="margin: 20px; padding: 10px 20px;">모든 스트림 중지</button> -->
    <script>
        const serverIp = "192.168.131.216";

        // 개별 스트림 재생 함수
        async function playStream(streamInfo, videoElement) {
            const pc = new RTCPeerConnection({ bundlePolicy: "max-bundle" });

            // 사파리 및 일반 브라우저 수신 설정
            pc.addTransceiver("video", { direction: "recvonly" });
            // 오디오가 있는 경우에만 추가 (라즈베리파이 카메라만 쓰면 보통 비디오만 하므로 주석 처리 권장)
            pc.addTransceiver("audio", { direction: "recvonly" });

            pc.ontrack = (event) => {
                if (videoElement.srcObject !== event.streams[0]) {
                    videoElement.srcObject = event.streams[0];
                    console.log(`${streamInfo.name} 트랙 수신됨`);
                }
            };

            const apiUrl = `http://${serverIp}:1985/rtc/v1/play/`;
            const streamUrl = `webrtc://${serverIp}${streamInfo.url}`;

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api: apiUrl, streamurl: streamUrl, sdp: offer.sdp
                    })
                });

                const data = await response.json();
                if (data.code !== 0) throw new Error("SRS 에러");

                await pc.setRemoteDescription(new RTCSessionDescription({
                    type: 'answer', sdp: data.sdp
                }));

                // await videoElement.play();

            } catch (e) {
                console.error(`${streamInfo.name} 연결 실패:`, e);
            }
        }

        function stopStream(streamInfo, videoElement) {
            videoElement.pause();
        }

        function getStreamList() {
            const apiUrl = `http://${serverIp}:1985/api/v1/streams`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    const sel = 'all'
                    const streamList = sel == 'all'
                        ? data.streams.map(s => ({ app: s.app, name: s.name, url: s.url }))
                        : data.streams.filter(a => a.app == sel).map(s => ({ app: s.app, name: s.name, url: s.url }));
                    console.log("현재 Publish 중인 WebRTC 스트림 목록:", streamList);
                    createVideoView(streamList);
                })

                .catch(err => console.log("Fetch error: " + err));
        }

        function createVideoView(streams) {
            // 페이지 초기화: 비디오 태그 생성
            const grid = document.getElementById('videoGrid');
            streams.forEach((s, index) => {
                const container = document.createElement('div');
                container.className = 'video-container';
                container.innerHTML =
                    `<video id="video_${index}" muted playsinline controls poster="http://${serverIp}:8080/thumbs/${s.app}_${s.name}.jpg"></video>
                <div class="video-title" id="name_${index}">${s.name}</div>`;
                grid.appendChild(container);

                // requestAnimationFrame(async () => {
                //     const videoEl = document.getElementById(`video_${index}`);
                //     await playStream(s, videoEl);
                // });

                const videoEl = document.getElementById(`video_${index}`);
                playStream(s, videoEl);

            });



            // 버튼 클릭 시 모든 스트림 순차 재생
            // document.getElementById('startAllBtn').onclick = () => {
            //     streams.forEach((streams, index) => {
            //         const videoEl = document.getElementById(`video_${index}`);
            //         playStream(streams, videoEl);
            //     });
            // };

            // document.getElementById('stopAllBtn').onclick = () => {
            //     streams.forEach((streams, index) => {
            //         const videoEl = document.getElementById(`video_${index}`);
            //         stopStream(streams, videoEl);
            //     });
            // }

        }

        getStreamList();

    </script>
</body>

</html>