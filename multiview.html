<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>데이터 받는 페이지</title>
    <style>
        body {
            margin: 0;
            display: grid;
            /* grid-template-columns: repeat(2, 1fr); */
            /* grid-template-rows: repeat(2, 1fr); */
            height: 100vh;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: 1px solid #222;
        }

        /* button {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
        } */

        body.layout-1 {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
        }

        body.layout-2 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: 1fr;
        }

        /* 1x2 */
        body.layout-4 {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        /* 2x2 */
        body.layout-6 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
        }

        /* 3x2 */
        body.layout-9 {
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
        }

        /* 3x3 */
    </style>
</head>

<body>
    <script>
        const serverIp = "192.168.135.242";

        // 페이지 로드 시 URL 파라미터 확인
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const items = urlParams.get('items');
            if (items) {
                const itemList = items.split(',');
                const streamInfo = itemList.map(str => {
                    const [app, name] = str.split('_');
                    return { app, name, url: `/${app}/${name}` };
                })

                console.log(streamInfo);
                createVideoView(streamInfo);
            }
        };

        // 개별 스트림 재생 함수
        async function playStream(streamInfo, videoElement) {
            const pc = new RTCPeerConnection({ bundlePolicy: "max-bundle" });

            // 사파리 및 일반 브라우저 수신 설정
            pc.addTransceiver("video", { direction: "recvonly" });
            // 오디오가 있는 경우에만 추가 (라즈베리파이 카메라만 쓰면 보통 비디오만 하므로 주석 처리 권장)
            pc.addTransceiver("audio", { direction: "recvonly" });

            pc.ontrack = (event) => {
                if (videoElement.srcObject !== event.streams[0]) {
                    videoElement.srcObject = event.streams[0];
                    console.log(`${streamInfo.name} 트랙 수신됨`);
                }
            };

            const apiUrl = `https://${serverIp}:1988/rtc/v1/play/`;
            const streamUrl = `webrtc://${serverIp}${streamInfo.url}`;

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api: apiUrl, streamurl: streamUrl, sdp: offer.sdp
                    })
                });

                const data = await response.json();
                if (data.code !== 0) throw new Error("SRS 에러");

                await pc.setRemoteDescription(new RTCSessionDescription({
                    type: 'answer', sdp: data.sdp
                }));

                // await videoElement.play();

            } catch (e) {
                console.error(`${streamInfo.name} 연결 실패:`, e);
            }
        }

        function createVideoView(streams) {
            // 페이지 초기화: 비디오 태그 생성
            // const grid = document.getElementById('videoGrid');
            const count = streams.length;
            const body = document.body;

            if (count === 1) body.classList.add('layout-1');
            else if (count <= 2) body.classList.add('layout-2');
            else if (count <= 4) body.classList.add('layout-4');
            else if (count <= 6) body.classList.add('layout-6');
            else body.classList.add('layout-9');

            streams.forEach((s, index) => {
                const container = document.createElement('div');
                container.className = 'video-container';
                container.innerHTML =
                    `<video id="video_${index}" muted playsinline controls poster="https://${serverIp}:8088/thumbs/${s.app}_${s.name}.jpg"></video>
                <div class="video-title" id="name_${index}">${s.app} ${s.name}"</div>`;
                document.body.appendChild(container);

                // requestAnimationFrame(async () => {
                //     const videoEl = document.getElementById(`video_${index}`);
                //     await playStream(s, videoEl);
                // });

                const videoEl = document.getElementById(`video_${index}`);
                playStream(s, videoEl);
            });
        }

    </script>
</body>

</html>