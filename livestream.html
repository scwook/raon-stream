<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Mobile WebRTC Camera Publisher</title>
    <style>
        body {
            background-color: #0f0f0f;
            font-family: sans-serif;
            text-align: center;
            padding: 20px;
            color: white;
        }

        video {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;

            background: #000;
            border-radius: 12px;
        }

        button,
        select {
            margin: 10px;
            padding: 12px 20px;
            font-size: 16px;
            border-radius: 8px;
            border: none;
            background: #007AFF;
            color: white;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <h2>COSMOS Web Streaming</h2>

    <video id="preview" autoplay playsinline muted></video>

    <br>

    <select id="cameraSelect"></select>
    <br>

    <button id="startBtn">Ïπ¥Î©îÎùº ÏºúÍ∏∞</button>
    <button id="publishBtn" disabled>Î∞©ÏÜ° ÏãúÏûë</button>

    <div id="status">Ï§ÄÎπÑÎê®</div>

    <script>
        const server = "192.168.131.216";   // ‚Üê Ïó¨Í∏∞Î•º Î≥∏Ïù∏ SRS Ï£ºÏÜåÎ°ú Î≥ÄÍ≤Ω
        const app = "live";
        const stream = "mobilecam";
        const whipUrl = `https://${server}:1988/rtc/v1/whip/?app=${app}&stream=${stream}`;

        let localStream = null;
        let pc = null;

        // üìå Ïπ¥Î©îÎùº Î™©Î°ù Î∂àÎü¨Ïò§Í∏∞
        async function loadCameras() {
            try {
                // ÏûÑÏãúÎ°ú Í∂åÌïúÏùÑ ÏöîÏ≤≠ÌïòÏó¨ Ïû•Ïπò Î™©Î°ù Ï†ëÍ∑º Í∂åÌïú ÌôïÎ≥¥
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();

                // ÏÇ¨Ïö© ÌõÑ ÏûÑÏãú Ïä§Ìä∏Î¶º Ï†ïÏßÄ
                stream.getTracks().forEach(track => track.stop());

                const cams = devices.filter(d => d.kind === "videoinput");
                const select = document.getElementById("cameraSelect");
                select.innerHTML = "";

                cams.forEach(cam => {
                    const op = document.createElement("option");
                    op.value = cam.deviceId;
                    op.text = cam.label || `Ïπ¥Î©îÎùº ${select.length + 1}`;
                    select.appendChild(op);
                });
            } catch (err) {
                console.error("Ïû•Ïπò Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§:", err);
                document.getElementById("status").innerText = "Ïπ¥Î©îÎùº Í∂åÌïú ÌïÑÏöî (HTTPS ÌôïÏù∏)";
            }
        }

        // üìå Ïπ¥Î©îÎùº ÏãúÏ≤≠ ÏãúÏûë
        async function startCamera() {
            const camId = document.getElementById("cameraSelect").value;

            // Í∏∞Ï°¥ Ïä§Ìä∏Î¶ºÏù¥ ÏûàÎã§Î©¥ Î®ºÏ†Ä Ï§ëÏßÄ (Ï§ëÏöî!)
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            const constraints = {
                video: {
                    // exact ÎåÄÏã† ideal ÏÇ¨Ïö© (Îçî Ïú†Ïó∞Ìï®)
                    deviceId: camId ? { ideal: camId } : undefined,
                    // Î™®Î∞îÏùº Î∞∞Î†§: ÌõÑÎ©¥ Ïπ¥Î©îÎùº Ïö∞ÏÑ† Ïãú ideal: "environment"
                },
                audio: true
            };

            try {
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById("preview").srcObject = localStream;
                document.getElementById("publishBtn").disabled = false;
                document.getElementById("status").innerText = "Ïπ¥Î©îÎùº Ïó∞Í≤∞Îê®";
            } catch (err) {
                console.error("ÏóêÎü¨ ÏÉÅÏÑ∏:", err);
                document.getElementById("status").innerText = `ÏóêÎü¨: ${err.name}`;
            }
        }

        // üìå WebRTC + WHIP ÏÜ°Ï∂ú
        async function publishStream() {
            document.getElementById("status").innerText = "WebRTC Ïó∞Í≤∞ Ï§ë...";

            pc = new RTCPeerConnection({
                bundlePolicy: "max-bundle"
            });

            // Tracks ÎÑ£Í∏∞
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            // Offer ÏÉùÏÑ±
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            // SRS WHIP APIÎ°ú SDP Ï†ÑÏÜ°
            const res = await fetch(whipUrl, {
                method: "POST",
                headers: { "Content-Type": "application/sdp" },
                body: offer.sdp
            });

            const answerSdp = await res.text();

            // answer ÏÑ§Ï†ï
            await pc.setRemoteDescription({
                type: "answer",
                sdp: answerSdp
            });

            document.getElementById("status").innerText = "üì° Î∞©ÏÜ° Ï§ë";
        }

        document.getElementById("startBtn").onclick = startCamera;
        document.getElementById("publishBtn").onclick = publishStream;

        // Ï¥àÍ∏∞ Ïπ¥Î©îÎùº Î™©Î°ù Î°úÎìú
        loadCameras();
    </script>

</body>

</html>
