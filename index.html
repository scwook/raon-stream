<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSMOS</title>
    <style>
        body {
            background-color: #0f0f0f;
        }

        #header {
            display: flex;
            width: 100%;
            height: 60px;
            padding: 20px;
            margin: auto;
            /* background-color: aliceblue; */
        }

        #logo {
            display: flex;
            flex: 1;
            align-items: center;
        }

        #title {
            flex: 3;
            display: flex;
            position: relative;
            color: white;
            justify-content: center;
            align-items: center;
        }

        #title-name {
            width: 100%;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: clamp(14px, 2vw, 32px);
            display: none; 
        }

        .video-grid {
            display: grid;
            /* grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); */
            grid-template-columns: 1fr;

            gap: 20px;
            padding: 20px;
        }

        .video-container {
            background: #0f0f0f;
            /* border-radius: 8px; */
            overflow: hidden;
            color: white;
        }

        video {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 10px;
        }

        .video-title {
            font-size: 20px;
            color: white;
            padding: 5px;
        }

        h2 {
            color: white;
        }

        /* [2] 브라우저가 최소 300px 영상 2개를 넣을 수 있을 때 (약 620px 이상) */
        @media (min-width: 650px) {
            .video-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* [3] 브라우저가 최소 300px 영상 3개를 넣을 수 있을 때 (약 940px 이상) */
        /* 1600px 미만까지는 여기서 3개로 계속 유지됩니다. */
        @media (min-width: 980px) {
            .video-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* [4] 1600px 이상일 때만 4개로 확장 */
        @media (min-width: 1600px) {
            .video-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>

<body>

    <div id="header">
        <div id="logo">
            <svg width="176" height="26">
                <defs>
                    <style>
                        .cls-1 {
                            fill: #0f0f0f;
                        }

                        .cls-1,
                        .cls-2 {
                            stroke-width: 0px;
                        }

                        .cls-2 {
                            fill: #fff;
                        }
                    </style>
                </defs>
                <path class="cls-2"
                    d="M11.65,25.03c-1.62,0-3.14-.31-4.55-.93-1.41-.62-2.65-1.48-3.72-2.58-1.07-1.1-1.9-2.38-2.49-3.83-.59-1.45-.89-3.02-.89-4.7s.3-3.22.89-4.67c.59-1.45,1.42-2.72,2.48-3.82,1.06-1.09,2.3-1.95,3.71-2.58s2.94-.95,4.58-.95c1.46,0,2.77.21,3.94.62,1.16.41,2.29,1.08,3.39,2,.18.14.3.3.35.47.05.17.05.34,0,.5-.05.16-.13.3-.23.42-.04.22-.16.4-.35.53-.19.13-.42.2-.68.2s-.52-.1-.78-.3c-.76-.68-1.58-1.19-2.46-1.52-.88-.33-1.94-.5-3.18-.5s-2.45.26-3.56.77c-1.11.51-2.09,1.21-2.93,2.09-.84.88-1.5,1.9-1.97,3.06-.47,1.16-.71,2.39-.71,3.69s.24,2.59.71,3.75c.47,1.16,1.13,2.18,1.97,3.06.84.88,1.82,1.57,2.93,2.07,1.11.5,2.3.75,3.56.75,1.06,0,2.07-.18,3.03-.54.96-.36,1.88-.87,2.76-1.53.28-.22.57-.31.86-.27.29.04.54.17.75.38.21.21.32.5.32.86,0,.18-.03.34-.09.48-.06.14-.15.29-.27.45-1.04.9-2.19,1.56-3.44,1.97-1.25.41-2.56.62-3.92.62Z" />
                <path class="cls-2"
                    d="M73.59,25.03c-1.28,0-2.48-.19-3.59-.57-1.11-.38-2.08-.92-2.9-1.61-.82-.69-1.43-1.5-1.83-2.42-.18-.34-.19-.66-.02-.96.17-.3.46-.5.86-.6.3-.08.6-.05.9.11s.52.39.66.71c.3.56.74,1.07,1.31,1.52.57.45,1.25.8,2.04,1.05.79.25,1.65.38,2.57.38,1.04,0,1.97-.17,2.79-.51.82-.34,1.47-.83,1.95-1.47.48-.64.72-1.42.72-2.34,0-1.16-.44-2.18-1.32-3.05-.88-.87-2.28-1.42-4.21-1.64-2.38-.28-4.25-1.01-5.6-2.19s-2.03-2.64-2.03-4.39c0-1.24.34-2.32,1.02-3.23.68-.91,1.61-1.61,2.79-2.1,1.18-.49,2.52-.74,4.03-.74,1.14,0,2.16.18,3.06.53.9.35,1.69.82,2.36,1.4.67.58,1.23,1.23,1.67,1.95.24.36.33.71.26,1.04-.07.33-.26.59-.56.77-.32.16-.66.19-1.01.07-.35-.11-.62-.33-.8-.65-.3-.48-.68-.93-1.13-1.34-.45-.41-1-.74-1.64-.98-.64-.24-1.4-.37-2.28-.39-1.54,0-2.8.32-3.78.96-.98.64-1.47,1.59-1.47,2.85,0,.64.17,1.25.53,1.82.35.57.94,1.06,1.77,1.46.83.4,1.97.7,3.41.9,2.48.32,4.35,1.07,5.59,2.25,1.24,1.18,1.86,2.73,1.86,4.66,0,1.1-.21,2.07-.62,2.91-.41.84-.99,1.55-1.73,2.12-.74.57-1.6,1-2.57,1.29-.97.29-2,.44-3.08.44Z" />
                <path class="cls-2"
                    d="M92.73,24.73c-.36,0-.67-.12-.92-.38-.25-.25-.38-.56-.38-.92V2.56c0-.38.12-.69.38-.93.25-.24.56-.36.92-.36.52,0,.9.22,1.14.66l9.91,19.74h-.99L112.5,1.93c.26-.44.64-.66,1.14-.66.36,0,.66.12.9.36.24.24.36.55.36.93v20.88c0,.36-.12.67-.36.92-.24.25-.54.38-.9.38-.38,0-.7-.12-.95-.38-.25-.25-.38-.56-.38-.92V5.99l.54-.03-8.56,17.48c-.24.42-.61.63-1.11.63-.54,0-.94-.26-1.2-.78l-8.56-17.15.6-.15v17.45c0,.36-.13.67-.38.92-.25.25-.56.38-.92.38Z" />
                <path class="cls-2"
                    d="M136.75,25.03c-1.74,0-3.34-.3-4.81-.9-1.46-.6-2.73-1.44-3.8-2.51-1.07-1.07-1.9-2.34-2.48-3.81-.58-1.47-.87-3.08-.87-4.82s.29-3.34.87-4.81c.58-1.46,1.41-2.73,2.48-3.8,1.07-1.07,2.34-1.91,3.8-2.51,1.46-.6,3.06-.9,4.81-.9s3.34.3,4.79.9c1.45.6,2.72,1.44,3.8,2.51s1.91,2.34,2.49,3.8c.58,1.46.87,3.06.87,4.81s-.29,3.35-.87,4.82c-.58,1.47-1.41,2.74-2.49,3.81-1.08,1.07-2.35,1.91-3.8,2.51-1.45.6-3.05.9-4.79.9ZM136.75,22.63c1.36,0,2.62-.24,3.77-.74,1.15-.49,2.15-1.17,3-2.04s1.51-1.89,1.97-3.06c.46-1.17.69-2.44.69-3.8s-.23-2.63-.69-3.8c-.46-1.17-1.12-2.19-1.97-3.06s-1.85-1.55-3-2.03c-1.15-.48-2.41-.72-3.77-.72s-2.62.24-3.78.72c-1.16.48-2.16,1.16-3,2.03-.84.87-1.5,1.89-1.97,3.06-.47,1.17-.71,2.44-.71,3.8s.24,2.63.71,3.8c.47,1.17,1.13,2.19,1.97,3.06.84.87,1.84,1.55,3,2.04,1.16.49,2.42.74,3.78.74Z" />
                <path class="cls-2"
                    d="M167.15,25.03c-1.28,0-2.48-.19-3.59-.57-1.11-.38-2.08-.92-2.9-1.61-.82-.69-1.43-1.5-1.83-2.42-.18-.34-.19-.66-.02-.96.17-.3.46-.5.86-.6.3-.08.6-.05.9.11s.52.39.66.71c.3.56.74,1.07,1.31,1.52s1.25.8,2.04,1.05c.79.25,1.65.38,2.57.38,1.04,0,1.97-.17,2.79-.51.82-.34,1.47-.83,1.95-1.47.48-.64.72-1.42.72-2.34,0-1.16-.44-2.18-1.32-3.05-.88-.87-2.28-1.42-4.21-1.64-2.38-.28-4.25-1.01-5.6-2.19s-2.03-2.64-2.03-4.39c0-1.24.34-2.32,1.02-3.23.68-.91,1.61-1.61,2.79-2.1,1.18-.49,2.52-.74,4.03-.74,1.14,0,2.16.18,3.06.53.9.35,1.69.82,2.36,1.4.67.58,1.23,1.23,1.67,1.95.24.36.33.71.26,1.04-.07.33-.26.59-.56.77-.32.16-.66.19-1.01.07-.35-.11-.62-.33-.8-.65-.3-.48-.68-.93-1.13-1.34-.45-.41-1-.74-1.64-.98-.64-.24-1.4-.37-2.28-.39-1.54,0-2.8.32-3.78.96-.98.64-1.47,1.59-1.47,2.85,0,.64.18,1.25.53,1.82s.94,1.06,1.77,1.46c.83.4,1.97.7,3.41.9,2.48.32,4.35,1.07,5.59,2.25,1.24,1.18,1.86,2.73,1.86,4.66,0,1.1-.21,2.07-.62,2.91-.41.84-.99,1.55-1.73,2.12-.74.57-1.6,1-2.57,1.29-.97.29-2,.44-3.08.44Z" />
                <circle class="cls-2" cx="42.31" cy="13" r="13" />
                <path class="cls-1"
                    d="M49.48,11.75l-10.01-5.99c-1.25-.75-2.83.15-2.83,1.61v11.34c0,1.45,1.58,2.35,2.83,1.61l10.01-5.99c.97-.58.97-1.99,0-2.57Z" />
            </svg>
        </div>
        <div id="title">
            <span id="title-name">COntrol System MOnitoring Streaming</span>
        </div>
    </div>
    <div class="video-grid" id="videoGrid"></div>
    <!-- <button id="startAllBtn" style="margin: 20px; padding: 10px 20px;">모든 스트림 시작</button> -->
    <!-- <button id="stopAllBtn" style="margin: 20px; padding: 10px 20px;">모든 스트림 중지</button> -->
    <script>
        const serverIp = "192.168.135.242";

        // 개별 스트림 재생 함수
        async function playStream(streamInfo, videoElement) {
            const pc = new RTCPeerConnection({ bundlePolicy: "max-bundle" });

            // 사파리 및 일반 브라우저 수신 설정
            pc.addTransceiver("video", { direction: "recvonly" });
            // 오디오가 있는 경우에만 추가 (라즈베리파이 카메라만 쓰면 보통 비디오만 하므로 주석 처리 권장)
            pc.addTransceiver("audio", { direction: "recvonly" });

            pc.ontrack = (event) => {
                if (videoElement.srcObject !== event.streams[0]) {
                    videoElement.srcObject = event.streams[0];
                    console.log(`${streamInfo.name} 트랙 수신됨`);
                }
            };

            const apiUrl = `https://${serverIp}:1988/rtc/v1/play/`;
            const streamUrl = `webrtc://${serverIp}${streamInfo.url}`;

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api: apiUrl, streamurl: streamUrl, sdp: offer.sdp
                    })
                });

                const data = await response.json();
                if (data.code !== 0) throw new Error("SRS 에러");

                await pc.setRemoteDescription(new RTCSessionDescription({
                    type: 'answer', sdp: data.sdp
                }));

                // await videoElement.play();

            } catch (e) {
                console.error(`${streamInfo.name} 연결 실패:`, e);
            }
        }

        function stopStream(streamInfo, videoElement) {
            videoElement.pause();
        }

        function getStreamList() {
            const apiUrl = `https://${serverIp}:1988/api/v1/streams`;

            fetch(apiUrl)
                .then(res => res.json())
                .then(data => {
                    const sel = 'all'
                    const streamList = sel == 'all'
                        ? data.streams.map(s => ({ app: s.app, name: s.name, url: s.url }))
                        : data.streams.filter(a => a.app == sel).map(s => ({ app: s.app, name: s.name, url: s.url }));
                    console.log("현재 Publish 중인 WebRTC 스트림 목록:", streamList);
                    createVideoView(streamList);
                })

                .catch(err => console.log("Fetch error: " + err));
        }

        function createVideoView(streams) {
            // 페이지 초기화: 비디오 태그 생성
            const grid = document.getElementById('videoGrid');
            streams.forEach((s, index) => {
                const container = document.createElement('div');
                container.className = 'video-container';
                container.innerHTML =
                    `<video id="video_${index}" muted playsinline controls poster="https://${serverIp}:8088/thumbs/${s.app}_${s.name}.jpg"></video>
                <div class="video-title" id="name_${index}">${s.app} ${s.name}</div>`;
                grid.appendChild(container);

                // requestAnimationFrame(async () => {
                //     const videoEl = document.getElementById(`video_${index}`);
                //     await playStream(s, videoEl);
                // });

                const videoEl = document.getElementById(`video_${index}`);
                playStream(s, videoEl);

            });



            // 버튼 클릭 시 모든 스트림 순차 재생
            // document.getElementById('startAllBtn').onclick = () => {
            //     streams.forEach((streams, index) => {
            //         const videoEl = document.getElementById(`video_${index}`);
            //         playStream(streams, videoEl);
            //     });
            // };

            // document.getElementById('stopAllBtn').onclick = () => {
            //     streams.forEach((streams, index) => {
            //         const videoEl = document.getElementById(`video_${index}`);
            //         stopStream(streams, videoEl);
            //     });
            // }

        }

        getStreamList();

    </script>
</body>

</html>