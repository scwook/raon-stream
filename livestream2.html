<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Mobile WebRTC Camera Publisher</title>
    <style>
        body { background-color: #0f0f0f; font-family: sans-serif; text-align: center; padding: 20px; color: white; }
        video { width: 100%; max-width: 800px; aspect-ratio: 16/9; background: #000; border-radius: 12px; }
        button, select, input { margin: 10px; padding: 12px 20px; font-size: 16px; border-radius: 8px; border: none; }
        button { background: #007AFF; color: white; cursor: pointer; min-width: 120px; }
        button:disabled { background: #555; cursor: not-allowed; }
        #stopBtn { background: #FF3B30; display: none; } /* ì¤‘ë‹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        select, input { background: #333; color: white; border: 1px solid #555; }
        .input-group { margin-bottom: 10px; }
    </style>
</head>

<body>

    <h2>COSMOS Web Streaming</h2>

    <video id="preview" autoplay playsinline muted></video>

    <div class="input-group">
        <input type="text" id="streamName" placeholder="ìŠ¤íŠ¸ë¦¼ ì´ë¦„ ì…ë ¥" value="mobilecam">
        <select id="cameraSelect"></select>
    </div>

    <button id="startBtn">ì¹´ë©”ë¼ ì¼œê¸°</button>
    <button id="publishBtn" disabled>ë°©ì†¡ ì‹œì‘</button>
    <button id="stopBtn">ë°©ì†¡ ì¤‘ë‹¨</button>

    <div id="status">ì¤€ë¹„ë¨</div>

    <script>
        const server = "192.168.131.216"; // SRS ì£¼ì†Œ
        const app = "live";
        
        let localStream = null;
        let pc = null;

        // ğŸ“Œ ì¹´ë©”ë¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadCameras() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const devices = await navigator.mediaDevices.enumerateDevices();
                stream.getTracks().forEach(track => track.stop());

                const cams = devices.filter(d => d.kind === "videoinput");
                const select = document.getElementById("cameraSelect");
                select.innerHTML = "";
                cams.forEach(cam => {
                    const op = document.createElement("option");
                    op.value = cam.deviceId;
                    op.text = cam.label || `ì¹´ë©”ë¼ ${select.length + 1}`;
                    select.appendChild(op);
                });
            } catch (err) {
                console.error("ì¥ì¹˜ ëª©ë¡ ì—ëŸ¬:", err);
                document.getElementById("status").innerText = "ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
            }
        }

        // ğŸ“Œ ì¹´ë©”ë¼ ì¼œê¸°
        async function startCamera() {
            const camId = document.getElementById("cameraSelect").value;
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }

            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { deviceId: camId ? { ideal: camId } : undefined },
                    audio: true
                });
                document.getElementById("preview").srcObject = localStream;
                document.getElementById("publishBtn").disabled = false;
                document.getElementById("status").innerText = "ì¹´ë©”ë¼ ì—°ê²°ë¨";
            } catch (err) {
                document.getElementById("status").innerText = `ì¹´ë©”ë¼ ì—ëŸ¬: ${err.name}`;
            }
        }

        // ğŸ“Œ ë°©ì†¡ ì‹œì‘ (WebRTC + WHIP)
        async function publishStream() {
            const streamName = document.getElementById("streamName").value.trim();
            if (!streamName) {
                alert("ìŠ¤íŠ¸ë¦¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const whipUrl = `https://${server}:1988/rtc/v1/whip/?app=${app}&stream=${streamName}`;
            document.getElementById("status").innerText = "ë°©ì†¡ ì—°ê²° ì¤‘...";

            try {
                pc = new RTCPeerConnection({ bundlePolicy: "max-bundle" });

                // íŠ¸ë™ ì¶”ê°€
                localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const res = await fetch(whipUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/sdp" },
                    body: offer.sdp
                });

                if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì—ëŸ¬");

                const answerSdp = await res.text();
                await pc.setRemoteDescription({ type: "answer", sdp: answerSdp });

                // UI ì „í™˜
                document.getElementById("status").innerText = `ğŸ“¡ ë°©ì†¡ ì¤‘: ${streamName}`;
                document.getElementById("publishBtn").style.display = "none";
                document.getElementById("stopBtn").style.display = "inline-block";
                document.getElementById("streamName").disabled = true;

            } catch (err) {
                console.error(err);
                document.getElementById("status").innerText = "ë°©ì†¡ ì‹œì‘ ì‹¤íŒ¨";
            }
        }

        // ğŸ“Œ ë°©ì†¡ ì¤‘ë‹¨ ë¡œì§
        function stopPublishing() {
            // 1. PeerConnection ë‹«ê¸°
            if (pc) {
                pc.close();
                pc = null;
            }

            // 2. UI ë³µêµ¬
            document.getElementById("status").innerText = "ë°©ì†¡ ì¤‘ë‹¨ë¨";
            document.getElementById("publishBtn").style.display = "inline-block";
            document.getElementById("stopBtn").style.display = "none";
            document.getElementById("streamName").disabled = false;
            
            // ì°¸ê³ : ì¹´ë©”ë¼ ìì²´ë¥¼ ë„ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
            /*
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                document.getElementById("preview").srcObject = null;
                document.getElementById("publishBtn").disabled = true;
            }
            */
        }

        document.getElementById("startBtn").onclick = startCamera;
        document.getElementById("publishBtn").onclick = publishStream;
        document.getElementById("stopBtn").onclick = stopPublishing;

        loadCameras();
    </script>
</body>
</html>